<!DOCTYPE html>
<html lang="nl">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1" name="viewport"/>
<title>QR SafeShare - Samenvoegen</title>
<link href="favicon.ico" rel="icon" type="image/x-icon"/>
<link href="apple-touch-icon.png" rel="apple-touch-icon"/>
<link href="lib/tailwind.min.css" rel="stylesheet"/>
<script src="lib/secrets.min.js"></script>
<style>
    /* Scanner sizing fix for desktop browsers */
    #reader {
      position: relative;
      max-width: 640px;
      height: 320px;
      margin: 0 auto;
      overflow: hidden; /* prevent video from overlapping following sections */
    }
    /* Ensure the injected video/canvas by html5-qrcode fits inside the box */
    #reader video,
    #reader__scan_region video,
    #reader canvas,
    #reader__scan_region canvas {
      width: 100% !important;
      height: 100% !important;
      object-fit: cover;
      border-radius: 0.75rem;
      display: block;
    }
    #reader__scan_region { height: 100% !important; }
    @media (max-width: 640px){
      #reader { height: 260px; }
    }
  </style>
</head>
<body class="bg-gray-50 font-sans text-gray-900">
<div class="max-w-5xl mx-auto p-6 space-y-6">
  <!-- Header -->
  <header class="mb-6 text-center flex flex-col items-center gap-2">
    <a class="flex flex-col items-center hover:opacity-80" href="combine.html">
      <img alt="QR SafeShare logo" class="w-16 h-16" src="logo.svg"/>
      <span class="text-3xl font-bold text-teal-700">QR SafeShare</span>
    </a>
    <p class="text-gray-600">Geheimen samenvoegen uit QR-codes</p>
  </header>
  <!-- Scanner + upload -->
  <section class="bg-yellow-300 rounded-xl shadow p-6 space-y-4">
    <div class="flex justify-between items-center mb-3">
      <h2 class="text-lg font-semibold">QR Scanner</h2>
      <button id="toggleCameraBtn" class="bg-teal-600 text-white mb-4 rounded px-3 py-2">
        Camera uitschakelen
      </button>
    </div>
    <div class="w-full h-64 bg-red-600 border rounded" id="reader"></div>
    <hr class="text-gray-500">
    <label for="fileInput" class="block text-sm font-medium text-gray-500 mb-1">
       Upload een QR-code afbeelding of tekstbestand (bijv. QR-shamir_sss-MySecret-SP96-T2-1.png)
    </label>
    <input accept="image/*" class="mt-3 block w-full border rounded p-2" id="fileInput" type="file"/>
    <!-- Nieuw: tekstveld voor handmatige invoer -->
    <hr class="text-gray-500">
    <div class="mb-3">
      <label for="manualShareInput" class="block text-sm font-medium text-gray-500 mb-1">
        Voeg een share handmatig toe:
      </label>
      <div class="flex gap-2">
        <input type="text" id="manualShareInput" class="flex-1 mt-3 border rounded p-2 bg-blue-600" placeholder="Plak hier de share (bijv. MySecret-SP96-T2-17F-CBB247FB)">
        <button id="addManualShareBtn" class="bg-teal-600 text-white rounded px-3 py-2">Toevoegen</button>
      </div>
    </div>
  </section>

  <!-- Gevonden delen -->
  <section class="bg-white rounded-xl shadow p-6">
    <!-- Voortgangsindicator -->
    <div id="progressIndicator" class="text-sm font-medium text-gray-700 mb-2">
      Nog geen QR-codes of priem getal gescand.
    </div>
    <div class="space-y-2" id="foundShares"></div>
    <div class="flex items-center justify-between mb-3">
      <h2 class="text-lg bg-yellfont-semibold">Gescande delen</h2>
      <button id="resetBtnTop" class="bg-gray-300 text-gray-800 rounded px-3 py-2">Reset</button>
    </div>
  </section>
  <!-- Resultaat -->
  <section class="bg-white rounded-xl shadow p-6 hidden" id="resultaat">
    <h2 class="text-lg font-semibold mb-3">Hersteld geheim</h2>
    <div class="bg-green-600" id="secretContainer"></div>
    <div class="flex gap-2 mt-3">
      <button class="flex-1 bg-teal-600 text-white rounded px-3 py-2" id="copyBtn">Kopieer</button>
      <button class="flex-1 bg-gray-300 text-gray-800 rounded px-3 py-2" id="resetBtn">Reset</button>
    </div>
    <!-- Buy Me a Coffee -->
    <div id="bmac-block" style="display:none; text-align:center; margin-top:20px;">
      <p class="text-gray-700 text-base mb-2">
        ‚òï Vind je QR SafeShare handig?<br/>
        Steun het project met een kop koffie:
      </p>
      <a href="https://buymeacoffee.com/qrsafeshare" rel="noopener" target="_blank">
        <img alt="Buy Me a Coffee" class="mx-auto" src="https://cdn.buymeacoffee.com/buttons/v2/default-yellow.png" style="height: 45px;"/>
      </a>
    </div>
  </section>
</div>
<!-- Duidelijkere beep (~500 Hz, 300 ms) via <audio> -->
<audio id="beepSound" preload="auto">
  <source src="data:audio/wav;base64,UklGRmQAAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQAAgP///wDwPwAA8D8AAPB/AADwfwAA8H8AAPB/AADwfwAA8H8AAPB/AADwfwAA8H8AAPB/AADwPwAA" type="audio/wav"/>
</audio>
<script src="lib/html5-qrcode.min.js"></script>
<script src="lib/jsqr.min.js"></script>
<script>
// --- Audio unlock + feedback (beep + vibratie) ---
(function(){
  function unlock(){
    const b=document.getElementById('beepSound');
    if (!b) return;
    const handler=()=>{
      b.muted=true;
      const pr=b.play();
      if(pr && pr.then){
        pr.then(()=>{ b.pause(); b.muted=false; b.currentTime=0; });
      } else {
        try{ b.pause(); b.muted=false; b.currentTime=0; }catch(e){}
      }
      window.removeEventListener('touchstart', handler, true);
      window.removeEventListener('click', handler, true);
      window.removeEventListener('keydown', handler, true);
    };
    window.addEventListener('touchstart', handler, true);
    window.addEventListener('click', handler, true);
    window.addEventListener('keydown', handler, true);
  }
  if(document.readyState==='complete' || document.readyState==='interactive'){
    unlock();
  } else {
    window.addEventListener('DOMContentLoaded', unlock);
  }
})();
const primes = { };

function getPrime(primeBits, customPrime) {
    if (customPrime) {
        // Accept custom prime in hex or decimal
        return typeof customPrime === 'string'
            ? parseInt(customPrime, 16)
            : customPrime;
    }
    return primes[primeBits];
}
function feedbackSuccess(){
  const beep=document.getElementById("beepSound");
  if(beep){
    const snd = beep.cloneNode(true);
    snd.style.display='none';
    document.body.appendChild(snd);
    try{ snd.currentTime=0; }catch(e){}
    snd.play().catch(()=>{});
    snd.addEventListener('ended', ()=>{ snd.remove(); });
  }
  if(navigator.vibrate){
    navigator.vibrate(150);
  }
}
// Opslag voor ontvangen shares and primes
let customPrime = 0n;
let shares = [];
let cameraActive = true; // Nieuw: camera status

// Nieuw: camera toggle
document.querySelector("#toggleCameraBtn").addEventListener("click", async () => {
  if (cameraActive) {
    try {
      await qr.stop();
      document.querySelector("#toggleCameraBtn").textContent = "Camera inschakelen";
      document.querySelector("#toggleCameraBtn").className = "bg-red-600 text-white rounded px-3 py-2 mb-4";
      showStatus("Camera uitgeschakeld", "info");
    } catch (e) {
      showStatus("Fout bij uitschakelen camera", "error");
    }
  } else {
    try {
      await qr.start(cameraConstraints, cameraConfig, handleScannedPayload);
      document.querySelector("#toggleCameraBtn").textContent = "Camera uitschakelen";
      document.querySelector("#toggleCameraBtn").className = "bg-teal-600 text-white rounded px-3 py-2 mb-4";
      showStatus("Camera ingeschakeld", "success");
    } catch (e) {
      showStatus("Fout bij inschakelen camera", "error");
    }
  }
  cameraActive = !cameraActive;
});

// Nieuw: voortgang bijwerken
function updateProgress() {
  const prog = document.querySelector("#progressIndicator");
  if (!prog) return;
  if (shares.length === 0) {
    if (customPrime) {
        prog.textContent = "Nog geen QR-codes gescand maar wel een priem getal.";
    } else {
        prog.textContent = "Nog geen QR-codes of priem getal gescand.";
    }
    prog.className = "text-sm font-medium text-gray-700 mb-2";
    return;
  }
  const totaal = shares[0].t;
  const huidig = shares.length;
  const resterend = Math.max(0, totaal - huidig);
  if (resterend > 0) {
    share_prime = shares[0]['prime_bits'];
    const div=document.createElement('div');
    if (customPrime) {
        prog.textContent = `Gescand: ${huidig}/${totaal} (nog ${resterend} te gaan), met eigen priemgetal ${customPrime.toString(16).toUpperCase()}`;
    } else {
      prog.textContent = `Gescand: ${huidig}/${totaal} (nog ${resterend} te gaan), met share priemgetal ${share_prime.toString(16).toUpperCase()}`;
    }
    prog.className = "text-sm font-medium text-orange-600 mb-2";
    document.body.appendChild(div);
  } else {
    const div=document.createElement('div');
    if (customPrime) {
        prog.textContent = `Alle benodigde QR-codes gescand (${huidig}/${totaal}) üéâ, met eigen priemgetal`;
    } else {
      prog.textContent = `Alle benodigde QR-codes gescand (${huidig}/${totaal}) üéâ, met share priemgetal ${share_prime.toString(16).toUpperCase()}`;
    }
    prog.className = "text-sm font-medium text-green-700 mb-2";
    document.body.appendChild(div);
  }
}
// Popup statusmeldingen
function showStatus(msg, type="info"){
  const old = document.querySelector(".popupStatus");
  if(old) old.remove();
  const div=document.createElement('div');
  div.textContent=msg;
  div.className='popupStatus fixed bottom-4 left-1/2 -translate-x-1/2 text-sm px-3 py-2 rounded-xl shadow z-50';
  if(type==="success"){ div.classList.add('bg-green-600','text-white'); }
  else if(type==="error"){ div.classList.add('bg-red-600','text-white'); }
  else { div.classList.add('bg-gray-900','text-white'); }
  document.body.appendChild(div);
  setTimeout(()=>div.remove(),2500);
}
// Share verwerken
function parseShareToDict(shareString) {
    // ID.CC59BA-SP96-T2-prime-87
    // ID.CC59BA-SP96-T2-800000006F3-57292A04639F2C2AA0B608DE
    const parts = shareString.split('-');
    if (parts.length < 5) {
        showStatus("Niet geldige QR code gescanned", "error");
    return {};
    }
    shareParts = {};
    shareParts['id'] = parts[0];
    shareParts['t'] = parseInt(parts[2].replace('T', ''), 10);
    shareParts['prime_bits'] = getPrime(parseInt(parts[1].replace('SP', ''), 10));
    if (shareString.includes('-prime-')) {
        shareParts['customPrime'] = BigInt("0x" + parts[4]);
        console.log("customPrime found! " + shareParts.customPrime);
    } else {
        shareParts['customPrime'] = 0;
        shareParts['x'] = BigInt("0x" + parts[3]);
        shareParts['y'] = BigInt("0x" + parts[4]);
        console.log("x,y pair found!");
    }
    return shareParts;
}
// Payload verwerken
function handleScannedPayload(text){
  try {
    const env = parseShareToDict(text.trim());
    // Wrong id, error
    if (shares.some(s => s.id !== env.id )) {
      const msg = `Deze QR hoort bij een andere set (id ${env.id}). Huidige set: ${shares[0].id}.`;
      showStatus(msg, "error");
      return;
    }
    // Duplicaat ‚Üí stil negeren
    if (shares.some(s => s.id === env.id && s.x === env.x)) {
      return;
    }
    // empty dictionary
    if (env.customPrime != 0) {
        customPrime = env.customPrime;
        const div=document.createElement('div');
        div.textContent = `Priem getal ontvangen ${customPrime.toString(16).toUpperCase()}!`;
        div.className="p-2 border rounded bg-gray-100 text-sm";
        document.querySelector("#foundShares").appendChild(div);
        showStatus(`Priem getal ontvangen ${customPrime.toString(16).toUpperCase()}`,"success");
        updateProgress();
        return;
    }
    // --- Validate that incoming share belongs to the same set ---
    if (shares.length > 0) {
      const cur = shares[0];
      if (env.id !== cur.id) {
        const msg = `Deze QR hoort bij een andere set (id ${env.id}). Huidige set: ${cur.id}.`;
        showStatus(msg, "error");
        return;
      }
      const k0 = Number(cur.k || 0);
      const k1 = Number(env.k || 0);
      if (k0 && k1 && k0 !== k1) {
        const msg = ``+`Drempel (k) verschilt: ontvangen ${k1}, huidig ${k0}.`;
        showStatus(msg, "error");
        return;
      }
    }
    shares.push(env);
    // voortgang bijwerken na toevoegen
    updateProgress();
    const div=document.createElement('div');
    div.textContent = `Deel ${env.x.toString(16)} ontvangen van set met id ${env.id}`;
    div.className="p-2 border rounded bg-gray-100 text-sm";
    document.querySelector("#foundShares").appendChild(div);
    showStatus(`QR gescand: deel ${env.x.toString(16)} ontvangen`,"success");
    feedbackSuccess();
    tryRestore();
  } catch(e) {
    console.error("Geen geldige payload", e);
    const t = String(text||"").trim();
    // Alleen melden als het *wel* JSON lijkt maar alsnog niet parsebaar is
    if (t.startsWith("{")) {
      showStatus("Geen geldige QR-code","error");
    }
    // Anders stil negeren (kan afkomstig zijn van willekeurige QR in camera of binaire data)
  }
}
// Geheim herstellen
function tryRestore(){
  if (shares.length < 2) return;
  if (shares.length < shares[0].t) return;
  const prime = customPrime ? customPrime : shares[0]['prime_bits'];
  const secret = decodeShares(shares, prime);
  showSecret(secret);
}
// Modular addition: (a + b) mod m
function modAdd(a, b, m) {
  return (a + b) % m;
}
// Modular subtraction: (a - b) mod m
function modSub(a, b, m) {
  return (a - b + m) % m;
}
// Modular multiplication: (a * b) mod m
function modMul(a, b, m) {
  return (a * b) % m;
}
// Modular inverse: (a^(-1)) mod m (using Extended Euclidean Algorithm)
function modInv(a, m) {
  let [oldR, r] = [a, m];
  let [oldS, s] = [1n, 0n];
  while (r !== 0n) {
    const quotient = oldR / r;
    [oldR, r] = [r, oldR - quotient * r];
    [oldS, s] = [s, oldS - quotient * s];
  }
  return oldS < 0 ? oldS + m : oldS;
}
// Lagrange interpolation to reconstruct the secret
function reconstructSecret(shares, prime) {
  let secret = 0n;
  for (let i = 0; i < shares.length; i++) {
    const { x: xi, y: yi } = shares[i];
    let numerator = 1n;
    let denominator = 1n;
    for (let j = 0; j < shares.length; j++) {
      if (i === j) continue;
      const { x: xj } = shares[j];
      numerator = modMul(numerator, xj, prime);
      denominator = modMul(denominator, modSub(xj, xi, prime), prime);
    }
    const lagrangeCoeff = modMul(yi, modMul(numerator, modInv(denominator, prime), prime), prime);
    secret = modAdd(secret, lagrangeCoeff, prime);
  }
  return secret;
}
// Main function to decode shares
function decodeShares(shares, customPrime = null) {
  // Parse shares
  // Validate shares
  const { id: firstId, t: threshold } = shares[0];
  if (!shares.every((s) => s.id === firstId)) {
    throw new Error("All shares must have the same ID.");
  }
  if (shares.length < threshold) {
    throw new Error(`At least ${threshold} shares are required.`);
  }
  // Use custom prime or predefined prime
  if (!customPrime) {
    throw new Error("Prime not found in predefined list.");
  }
  // Reconstruct secret
  const secret = reconstructSecret(shares, customPrime);
  // Convert secret to hex string and then to UTF-8
  const hexString = secret.toString(16);
  const secretBuffer = new Uint8Array(hexString.match(/.{1,2}/g).map((byte) => parseInt(byte, 16)));
  return new TextDecoder().decode(secretBuffer);
}
// Geheim tonen
function showSecret(txt){
  const cont=document.querySelector("#secretContainer");
  cont.innerHTML="";
  const ta=document.createElement("textarea");
  ta.rows=6;
  ta.className="w-full border rounded p-2 font-mono bg-green-600";
  ta.value=txt;
  cont.appendChild(ta);
  document.querySelector("#resultaat").classList.remove("hidden");
  document.querySelector("#bmac-block").style.display="block";
  setTimeout(()=>{ cont.scrollIntoView({behavior:"smooth"}); },300);
  showStatus("‚úÖ Geheim hersteld!","success");
  feedbackSuccess();
}
// Kopieer & reset
document.querySelector("#copyBtn").addEventListener("click", async ()=>{
  const ta=document.querySelector("#secretContainer textarea");
  let textToCopy="";
  if(ta){ textToCopy=ta.value; }
  else {
    textToCopy=[...document.querySelectorAll("#secretContainer li")].map(li=>li.textContent).join(" ");
  }
  try {
    await navigator.clipboard.writeText(textToCopy);
    showStatus("Geheim gekopieerd","success");
    feedbackSuccess();
  } catch {}
});
function doReset(){
  shares=[];
  customPrime = 0;
  updateProgress(); // Nieuw: voortgang resetten
  document.querySelector("#foundShares").innerHTML="";
  document.querySelector("#resultaat").classList.add("hidden");
  document.querySelector("#bmac-block").style.display="none";
  showStatus("Reset voltooid","info");
}
document.querySelector("#resetBtn").addEventListener("click", doReset);
const resetBtnTop = document.querySelector("#resetBtnTop");
if (resetBtnTop) resetBtnTop.addEventListener("click", doReset);

// Handmatige share invoer
document.querySelector("#addManualShareBtn").addEventListener("click", () => {
  const input = document.querySelector("#manualShareInput");
  const shareString = input.value.trim();
  if (!shareString) {
    showStatus("Voer een share in", "error");
    return;
  }
  try {
    handleScannedPayload(shareString);
    input.value = ""; // Clear input
  } catch (e) {
    showStatus("Ongeldige share", "error");
  }
});

// Enter-toevoegen ondersteunen
document.querySelector("#manualShareInput").addEventListener("keypress", (e) => {
  if (e.key === "Enter") {
    document.querySelector("#addManualShareBtn").click();
  }
});

// QR scanner starten (responsive qrbox + fixed aspect ratio to avoid oversized video)
const isMobile = /Android|iPhone|iPad|iPod/i.test(navigator.userAgent);
const qrbox = (vw, vh) => {
  const size = Math.floor(Math.min(vw, vh) * (isMobile ? 0.70 : 0.60));
  return { width: size, height: size };
};
const qr = new Html5Qrcode("reader");
const cameraConstraints = { facingMode: "environment" };
const cameraConfig = { fps: 10, qrbox, aspectRatio: 1.333 };
qr.start(cameraConstraints, cameraConfig, handleScannedPayload);

// Unified upload handler (image+text) met jsQR fallback
document.querySelector("#fileInput").addEventListener("change", async (e)=>{
  const file = e.target.files && e.target.files[0];
  if (!file) return;
  const name = (file.name || "").toLowerCase();
  const mime = (file.type || "");
  const looksImage = (mime.startsWith("image/")) || /\.(png|jpe?g|gif|bmp|webp)$/.test(name);
  try {
    if (looksImage) {
      let decodedText = null;
      // 1) html5-qrcode scanFile (requires no ongoing camera scan)
      if (typeof qr.scanFile === "function") {
        try {
          await qr.stop().catch(()=>{});
          decodedText = await qr.scanFile(file, true);
        } catch(_e){ decodedText = null; }
        finally {
          // restart camera for live scanning again
          try { await qr.start(cameraConstraints, cameraConfig, handleScannedPayload); } catch(_e){}
        }
      }
      // 2) jsQR fallback
      if (!decodedText && (typeof jsQR === "function")) {
        decodedText = await (async function decodeWithJsQR(f){
          const fr = new FileReader();
          const url = await new Promise((res, rej)=>{ fr.onerror=()=>rej(new Error("read error")); fr.onload=()=>res(String(fr.result||"")); fr.readAsDataURL(f); });
          await new Promise((resolve, reject)=>{
            const img = new Image();
            img.onload = ()=>resolve();
            img.onerror = ()=>reject(new Error("img load error"));
            img.src = url;
          });
          const canvas = document.createElement("canvas");
          const imgEl = new Image(); imgEl.src = url; await imgEl.decode();
          canvas.width = imgEl.width; canvas.height = imgEl.height;
          const ctx = canvas.getContext("2d", { willReadFrequently: true });
          ctx.drawImage(imgEl, 0, 0);
          const { data, width, height } = ctx.getImageData(0, 0, canvas.width, canvas.height);
          const res = jsQR(data, width, height);
          if (res && res.data) return res.data;
          return null;
        })(file);
      }
      if (decodedText) {
        const clean = String(decodedText||"").trim();
        try { handleScannedPayload(decodeURIComponent(clean)); } catch { handleScannedPayload(clean); }
        return;
      } else {
        showStatus("Geen QR gevonden in afbeelding. Upload de payload-tekst uit split.html.","error");
        return;
      }
    }
    // TEXT path
    const reader = new FileReader();
    reader.onload = () => {
      const txt = String(reader.result || "").trim();
      // notify('text: ' + txt, 'error');
      handleScannedPayload(txt);
    };
    reader.readAsText(file);
  } catch(err){
    console.error(err);
    showStatus("Upload-fout: "+err, "error");
  } finally {
    // clear selected file so the same file kan gekozen
    e.target.value = "";
  }
});
// Hash auto-loader
window.addEventListener("load", ()=>{
  if(location.hash.length > 1){
    try {
      const payload = decodeURIComponent(location.hash.substring(1));
      location.hash = ""; // schoonmaken
      handleScannedPayload(payload);
    } catch(e){
      showStatus("Kon hash niet verwerken","error");
    }
  }
});
</script>
<script>try{localStorage.setItem('qrs_lang','nl')}catch(e){}</script>
<footer class="mt-10 mb-6 text-xs text-gray-500 text-center space-y-1">
  <p>‚ö†Ô∏è Gebruik op eigen risico. Jij bent verantwoordelijk voor je geheime gegevens.</p>
</footer>
</body>
</html>
